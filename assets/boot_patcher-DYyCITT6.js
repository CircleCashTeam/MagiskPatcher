(function(){"use strict";importScripts("/MagiskPatcher/magiskboot.js");function o(s){self.postMessage({type:"response",data:s})}function r(s){self.postMessage({type:"error",data:s})}function h(s){self.postMessage({type:"command",data:s})}self.onmessage=async function(s){const{apkBuffer:y,bootBuffer:E,needed:k,metadata:n}=s.data;console.log("Worker with options:",n);let u="";const i=await magiskboot({noInitialRun:!0,print:e=>{u=e.trim()},printErr:e=>h(e),locateFile:e=>"/MagiskPatcher/magiskboot.wasm"});function $(e,a){i.ccall("setenv","number",["string","string","number"],[e,a,1])}function c(e){return i.FS.analyzePath(e,!1).exists}function b(e,a){if(c(a)){const p=i.FS.readFile(a);i.FS.writeFile(e,p)}}function S(e,a){for(const p of e.split(`
`))if(p.includes("=")){const[A,P]=p.trim().split("=");if(A===a)return P}return""}for(const e in n.env)o(`Setup environment key: ${e} value: ${n.env[e]}`),$(e.toString(),n.env[e]);const t="/home/web_user";o("Chdir: "+t),i.FS.chdir(t),o(`Write boot image into emscripiten FS: ${t}/boot.img`),i.FS.writeFile(`${t}/boot.img`,new Uint8Array(E));for(const e in k){o(`Write file into emscripten FS: ${e} -> ${t}/${e}`);const a=new Uint8Array(k[e]);i.FS.writeFile(`${t}/${e}`,a)}let l=0;switch(o("- Unpacking boot image"),l=i.callMain(["unpack","boot.img"]),l){case 0:break;case 1:r("! Unsupported/Unknown image format");break;case 2:r("! Web unsupport ChromeOS boot image");break;default:r("! Unable to unpack boot image");break}o("- Checking ramdisk status");let f=0,m="";c("ramdisk.cpio")?(f=i.callMain(["cpio","ramdisk.cpio","test"]),m=""):(f=0,m="#");let g="";switch(f){case 0:o("- Stock boot image detected"),i.callMain(["sha1","boot.img"]),g=u,b(`${t}/ramdisk.cpio.orig`,`${t}/ramdisk.cpio`);break;case 1:o("- Magisk patched boot image detected"),i.callMain(["cpio","ramdisk.cpio","extract .backup/.magisk config.orig","restore"]),b(`${t}/ramdisk.cpio.orig`,`${t}/ramdisk.cpio`);break;case 2:o("! Boot image patched by unsupported programs"),r("! Please restore back to stock boot image");break}if(c("config.orig")){i.FS.chmod("config.orig",420);const e=i.FS.readFile("config.orig",{encoding:"utf8"});console.log("Get config from FS:",e),g=S(e,"SHA1"),console.log("SHA1 from origin config:",g),i.FS.unlink("config.orig")}o("- Patching ramdisk");let F=[];for(const e of["magisk","magisk32","magisk64","stub.apk","init-ld"])console.log("Try compress",e),c(e)&&(o(`Compress ${e} info xz...`),i.callMain(["compress=xz",e,`${e}.xz`]),F.push(`add 0644 overlay.d/sbin/${e}.xz ${e}.xz`));console.log("SHA1:",g);let d="";d+=`KEEPVERITY=${n.env.KEEPVERITY}
`,d+=`KEEPFORCEENCRYPT=${n.env.KEEPFORCEENCRYPT}
`,d+=`RECOVERYMODE=${n.env.RECOVERYMODE}
`,g.length!=0&&(d+=`SHA1=${g}
`),console.log("Generated magisk config",d),i.FS.writeFile(`${t}/config`,d,{encoding:"utf8"}),l=i.callMain(["cpio","ramdisk.cpio","add 0750 init magiskinit","mkdir 0750 overlay.d","mkdir 0750 overlay.d/sbin",...F,"patch",`${m} backup ramdisk.cpio.orig`,"mkdir 000 .backup","add 000 .backup/.magisk config"]),l!=0&&r("! Unable to patch ramdisk");for(const e of["dtb","kernel_dtb","extra"])c(`${t}/${e}`)&&(i.callMain(["dtb",e,"test"])!=0&&(o(`! Boot image ${e} was patched by old (unsupported) Magisk`),r("! Please try again with *unpatched* boot image")),i.callMain(["dtb",e,"patch"])==0&&o(`- Patch fstab in boot image ${e}`));if(c(`${t}/kernel`)){let e=!1;i.callMain(["hexpatch","kernel","49010054011440B93FA00F71E9000054010840B93FA00F7189000054001840B91FA00F7188010054","A1020054011440B93FA00F7140020054010840B93FA00F71E0010054001840B91FA00F7181010054"])==0&&(e=!0),i.callMain(["hexpatch","kernel","821B8012","E2FF8F12"])==0&&(e=!0),i.callMain(["hexpatch","kernel","70726F63615F636F6E66696700","70726F63615F6D616769736B00"])==0&&(e=!0),n.env.LEGACYSAR=="true"&&i.callMain(["hexpatch","kernel","736B69705F696E697472616D667300","77616E745F696E697472616D667300"])==0&&(e=!0),e||i.FS.unlink(`${t}/kernel`)}l=i.callMain(["repack","boot.img"]),l!=0&&r("! Unable to repack boot image");const M=i.FS.readFile(`${t}/new-boot.img`);this.postMessage({type:"done",data:M})}})();
